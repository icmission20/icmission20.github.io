<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
  <style>
    html, body {
      height: 100%;
      overflow: hidden;
    }
  </style>
  <script>
    function sendHit() {
      var urlData = [];
      var payload = "";
      const postUrl = "https://script.google.com/macros/s/AKfycbw_lzooqAJ9AOGOyehZfPV2bVUYnW3sJz1HKxOJEYcFwMkt6Z3RZlSAoW9ul-NzHbbn/exec";
      var pageUrl = window.location.href;
      
      /* Check if url contains parameters */
      if (!pageUrl.includes("?") || !pageUrl.includes("target=")) return;
      
      /* Sort parameters into an array */
      var parameters = pageUrl.split("?")[1];
      if (parameters.includes("&")) parameters = parameters.split("&");
      for (var i in parameters) {
        if (parameters[i].includes("=")) {
          urlData.push([parameters[i].split("=")[0], decodeURIComponent(parameters[i].split("=")[1])]);
        } else {
          urlData.push([parameters[i], ""]);
        }
      }
      
      /* Generate Json string to send */
      for (var i in urlData) {
        if (urlData[i][0] === "target") {
          urlData[i][1] = atob(urlData[i][1]);
          var target = urlData[i][1];
        }
        if (i == 0) payload = payload.concat("{");
        payload = payload.concat('"' + urlData[i][0] + '":"' + urlData[i][1] + '"');
        if (i < (urlData.length - 1)) payload = payload.concat(",");
        if (i == (urlData.length - 1)) payload = payload.concat("}");
      }
      
      /* Make a POST request with JSON body */
      fetch(postUrl, {
        method: "POST", 
        body: payload
      }).then(res => console.log("Request complete! response:", res));
      
      /* Redirect the user to target */
      window.location.replace(target + ? + pageUrl.split("?")[1]);
    }
  </script>
</head>
<body onload="sendHit()"></body>
</html>
